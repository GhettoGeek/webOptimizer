#!/usr/bin/env node


// -*- coding: utf-8 -*-
'use strict';
/* !
    region header
    Copyright Torben Sickert (info["~at~"]torben.website) 16.12.2012

    License
    -------

    This library written by Torben Sickert stand under a creative commons naming
    3.0 unported license. see http://creativecommons.org/licenses/by/3.0/deed.de
    endregion
*/
// region imports

var _child_process = require('child_process');

var _fs = require('fs');

var fileSystem = _interopRequireWildcard(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _rimraf = require('rimraf');

var _configurator = require('./configurator.compiled');

var _configurator2 = _interopRequireDefault(_configurator);

var _helper = require('./helper.compiled');

var _helper2 = _interopRequireDefault(_helper);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

// NOTE: Only needed for debugging this file.
try {
    require('source-map-support/register');
} catch (error) {}

// endregion
// region controller
const childProcessOptions = {
    cwd: _configurator2.default.path.context,
    env: process.env,
    shell: true,
    stdio: 'inherit'
};
const closeEventNames = ['exit', 'close', 'uncaughtException', 'SIGINT', 'SIGTERM', 'SIGQUIT'];
const childProcesses = [];
const processPromises = [];
const possibleArguments = ['build', 'buildDLL', 'clear', 'document', 'lint', 'preinstall', 'serve', 'test', 'testInBrowser', 'typeCheck'];
const closeEventHandlers = [];
if (_configurator2.default.givenCommandLineArguments.length > 2) {
    // region temporary save dynamically given configurations
    let dynamicConfiguration = { givenCommandLineArguments: _configurator2.default.givenCommandLineArguments.slice() };
    if (_configurator2.default.givenCommandLineArguments.length > 3 && _helper2.default.parseEncodedObject(_configurator2.default.givenCommandLineArguments[_configurator2.default.givenCommandLineArguments.length - 1], _configurator2.default, 'configuration')) _configurator2.default.givenCommandLineArguments.pop();
    let count = 0;
    let filePath = `${ _configurator2.default.path.context }.` + `dynamicConfiguration-${ count }.json`;
    while (true) {
        filePath = `${ _configurator2.default.path.context }.dynamicConfiguration-` + `${ count }.json`;
        if (!_helper2.default.isFileSync(filePath)) break;
        count += 1;
    }
    fileSystem.writeFileSync(filePath, JSON.stringify(dynamicConfiguration));
    const additionalArguments = process.argv.splice(3);
    // / region register exit handler to tidy up
    closeEventHandlers.push(function (error) {
        try {
            fileSystem.unlinkSync(filePath);
        } catch (error) {}
        if (error) throw error;
        return error;
    });
    // / endregion
    // endregion
    // region handle clear
    /*
        NOTE: A build could depend on previously created dll packages so a
        clean should not be performed in that case.
    */
    if (!['build', 'serve', 'testInBrowser'].includes(_configurator2.default.givenCommandLineArguments[2]) && possibleArguments.includes(_configurator2.default.givenCommandLineArguments[2])) {
        if (_path2.default.resolve(_configurator2.default.path.target) === _path2.default.resolve(_configurator2.default.path.context)) {
            // Removes all compiled files.
            _helper2.default.walkDirectoryRecursivelySync(_configurator2.default.path.target, (filePath, stat) => {
                if (_helper2.default.isFilePathInLocation(filePath, _configurator2.default.path.ignore)) return false;
                for (const type in _configurator2.default.build) if (new RegExp(_configurator2.default.build[type].fileNamePattern).test(filePath)) {
                    if (stat.isDirectory()) {
                        (0, _rimraf.sync)(filePath, {
                            glob: false });
                        return false;
                    }
                    fileSystem.unlinkSync(filePath);
                    break;
                }
            });
            fileSystem.readdirSync(_configurator2.default.path.target).forEach(fileName => {
                if (fileName.length > '.dll-manifest.json'.length && fileName.endsWith('.dll-manifest.json')) fileSystem.unlinkSync(_path2.default.resolve(_configurator2.default.path.target, fileName));
            });
        } else (0, _rimraf.sync)(_configurator2.default.path.target, {
            glob: false });
        try {
            (0, _rimraf.sync)(_configurator2.default.path.apiDocumentation, { glob: false });
        } catch (error) {}
    }
    // endregion
    // region handle build
    const buildConfigurations = _helper2.default.resolveBuildConfigurationFilePaths(_configurator2.default.build, _configurator2.default.path.asset.source, _configurator2.default.path.context, _configurator2.default.path.ignore);
    if (['build', 'buildDLL', 'document', 'test'].includes(process.argv[2])) {
        let tidiedUp = false;
        const tidyUp = () => {
            /*
                Determines all none javaScript entities which have been emitted
                as single javaScript module to remove.
            */
            if (tidiedUp) return;
            tidiedUp = true;
            const internalInjection = _helper2.default.normalizeInternalInjection(_helper2.default.resolveInjection(_configurator2.default.injection, buildConfigurations, _configurator2.default.testInBrowser.injection.internal, _configurator2.default.module.aliases, _configurator2.default.knownExtensions, _configurator2.default.path.context, _configurator2.default.path.ignore).internal);
            for (const chunkName in internalInjection) if (internalInjection.hasOwnProperty(chunkName)) for (const moduleID of internalInjection[chunkName]) {
                const type = _helper2.default.determineAssetType(_helper2.default.determineModuleFilePath(moduleID), _configurator2.default.build, _configurator2.default.path);
                // TODO replace all placeholder like [hash] [id] ...
                const filePath = _configurator2.default.files.compose.javaScript.replace('[name]', _path2.default.join(_path2.default.relative(_path2.default.dirname(moduleID), _configurator2.default.path.context), _path2.default.basename(moduleID))).replace(/\?[^?]+$/, '');
                if (typeof type === 'string' && _configurator2.default.build[type]) if (_configurator2.default.build[type].outputExtension === 'js') try {
                    fileSystem.chmodSync(filePath, '755');
                } catch (error) {} else for (const suffix of ['', '.map']) try {
                    fileSystem.unlinkSync(filePath + suffix);
                } catch (error) {}
            }
            for (const filePath of _configurator2.default.path.tidyUp) try {
                fileSystem.unlinkSync(filePath);
            } catch (error) {}
        };
        closeEventHandlers.push(tidyUp);
        /*
            Triggers complete asset compiling and bundles them into the final
            productive output.
        */
        processPromises.push(new Promise((resolve, reject) => {
            const commandLineArguments = (_configurator2.default.commandLine.build.arguments || []).concat(additionalArguments);
            console.log('Running "' + (`${ _configurator2.default.commandLine.build.command } ` + commandLineArguments.join(' ')).trim() + '"');
            const childProcess = (0, _child_process.spawn)(_configurator2.default.commandLine.build.command, commandLineArguments, childProcessOptions);
            const copyAdditionalFilesAndTidyUp = () => {
                for (const filePath of _configurator2.default.files.additionalPaths) {
                    const sourcePath = _path2.default.join(_configurator2.default.path.source, filePath);
                    try {
                        if (fileSystem.lstatSync(sourcePath).isDirectory()) _helper2.default.copyDirectoryRecursiveSync(sourcePath, _configurator2.default.path.target);else _helper2.default.copyFileSync(sourcePath, _configurator2.default.path.target);
                    } catch (error) {
                        break;
                    }
                }
                tidyUp();
            };
            for (const closeEventName of closeEventNames) childProcess.on(closeEventName, _helper2.default.getProcessCloseHandler(resolve, reject, closeEventName, process.argv[2] === 'build' ? copyAdditionalFilesAndTidyUp : tidyUp));
            childProcesses.push(childProcess);
        }));
        // endregion
        // region handle preinstall
    } else if (_configurator2.default.library && _configurator2.default.givenCommandLineArguments[2] === 'preinstall') {
            // Perform all file specific preprocessing stuff.
            const testModuleFilePaths = _helper2.default.determineModuleLocations(_configurator2.default.testInBrowser.injection.internal, _configurator2.default.module.aliases, _configurator2.default.knownExtensions, _configurator2.default.path.context, _configurator2.default.path.ignore).filePaths;
            for (const buildConfiguration of buildConfigurations) for (const filePath of buildConfiguration.filePaths) if (!testModuleFilePaths.includes(filePath)) {
                const evaluationFunction = (global, self, buildConfiguration, path, additionalArguments, filePath) =>
                // IgnoreTypeCheck
                new Function('global', 'self', 'buildConfiguration', 'path', 'additionalArguments', 'filePath', 'return `' + buildConfiguration[_configurator2.default.givenCommandLineArguments[2]].trim() + '`')(global, self, buildConfiguration, path, additionalArguments, filePath);
                processPromises.push(new Promise((resolve, reject) => {
                    const command = evaluationFunction(global, _configurator2.default, buildConfiguration, _path2.default, additionalArguments, filePath);
                    console.log(`Running "${ command }"`);
                    _helper2.default.handleChildProcess((0, _child_process.exec)(command, childProcessOptions, error => {
                        if (error) reject(error);else resolve('exit');
                    }));
                }));
            }
        }
    // endregion
    // region handle remaining tasks
    const handleTask = type => processPromises.push(new Promise((resolve, reject) => {
        const commandLineArguments = (_configurator2.default.commandLine[type].arguments || []).concat(additionalArguments);
        console.log('Running "' + (`${ _configurator2.default.commandLine[type].command } ` + commandLineArguments.join(' ')).trim() + '"');
        const childProcess = (0, _child_process.spawn)(_configurator2.default.commandLine[type].command, commandLineArguments, childProcessOptions);
        for (const closeEventName of closeEventNames) childProcess.on(closeEventName, _helper2.default.getProcessCloseHandler(resolve, reject, closeEventName));
        childProcesses.push(childProcess);
    }));
    // / region synchronous
    if (['document', 'test'].includes(_configurator2.default.givenCommandLineArguments[2])) Promise.all(processPromises).then(() => handleTask(_configurator2.default.givenCommandLineArguments[2]));
    // / endregion
    // / region asynchronous
    else if (['lint', 'testInBrowser', 'typeCheck', 'serve'].includes(_configurator2.default.givenCommandLineArguments[2])) handleTask(_configurator2.default.givenCommandLineArguments[2]);
    // / endregion
    // endregion
}
let finished = false;
const closeHandler = function () {
    if (!finished) for (const closeEventHandler of closeEventHandlers) closeEventHandler.apply(this, arguments);
    finished = true;
};
for (const closeEventName of closeEventNames) process.on(closeEventName, closeHandler);
// IgnoreTypeCheck
if (require.main === module && (_configurator2.default.givenCommandLineArguments.length < 3 || !possibleArguments.includes(_configurator2.default.givenCommandLineArguments[2]))) console.log(`Give one of "${ possibleArguments.join('", "') }" as command line ` + 'argument. You can provide a json string as second parameter to ' + 'dynamically overwrite some configurations.\n');
// endregion
// region forward nested return codes
Promise.all(processPromises).catch(error => process.exit(
// IgnoreTypeCheck
error.returnCode));
// endregion
// region vim modline
// vim: set tabstop=4 shiftwidth=4 expandtab:
// vim: foldmethod=marker foldmarker=region,endregion:
// endregion

//# sourceMappingURL=data:application/json;base64,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QXdDLENBQXhDLENBQVg7QUFDSjtBQUNBO0FBQ0g7QUFDRCxJQUFJLFdBQW1CLEtBQXZCO0FBQ0EsTUFBTSxlQUFlLFlBQWdCO0FBQ2pDLFFBQUksQ0FBQyxRQUFMLEVBQ0ksS0FBSyxNQUFNLGlCQUFYLElBQXlDLGtCQUF6QyxFQUNJLGtCQUFrQixLQUFsQixDQUF3QixJQUF4QixFQUE4QixTQUE5QjtBQUNSLGVBQVcsSUFBWDtBQUNILENBTEQ7QUFNQSxLQUFLLE1BQU0sY0FBWCxJQUFvQyxlQUFwQyxFQUNJLFFBQVEsRUFBUixDQUFXLGNBQVgsRUFBMkIsWUFBM0I7QUFDSjtBQUNBLElBQUksUUFBUSxJQUFSLEtBQWlCLE1BQWpCLEtBQ0EsdUJBQWMseUJBQWQsQ0FBd0MsTUFBeEMsR0FBaUQsQ0FBakQsSUFDQSxDQUFDLGtCQUFrQixRQUFsQixDQUEyQix1QkFBYyx5QkFBZCxDQUF3QyxDQUF4QyxDQUEzQixDQUZELENBQUosRUFJSSxRQUFRLEdBQVIsQ0FDSyxpQkFBZSxrQkFBa0IsSUFBbEIsQ0FBdUIsTUFBdkIsQ0FBK0IscUJBQS9DLEdBQ0EsaUVBREEsR0FFQSw4Q0FISjtBQUlKO0FBQ0E7QUFDQSxRQUFRLEdBQVIsQ0FBWSxlQUFaLEVBQTZCLEtBQTdCLENBQW9DLEtBQUQsSUFBc0IsUUFBUSxJQUFSO0FBQ3JEO0FBQ0EsTUFBTSxVQUYrQyxDQUF6RDtBQUdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoidGFza1J1bm5lci5jb21waWxlZC5qcyIsInNvdXJjZXNDb250ZW50IjpbIiMhL3Vzci9iaW4vZW52IG5vZGVcbi8vIEBmbG93XG4vLyAtKi0gY29kaW5nOiB1dGYtOCAtKi1cbid1c2Ugc3RyaWN0J1xuLyogIVxuICAgIHJlZ2lvbiBoZWFkZXJcbiAgICBDb3B5cmlnaHQgVG9yYmVuIFNpY2tlcnQgKGluZm9bXCJ+YXR+XCJddG9yYmVuLndlYnNpdGUpIDE2LjEyLjIwMTJcblxuICAgIExpY2Vuc2VcbiAgICAtLS0tLS0tXG5cbiAgICBUaGlzIGxpYnJhcnkgd3JpdHRlbiBieSBUb3JiZW4gU2lja2VydCBzdGFuZCB1bmRlciBhIGNyZWF0aXZlIGNvbW1vbnMgbmFtaW5nXG4gICAgMy4wIHVucG9ydGVkIGxpY2Vuc2UuIHNlZSBodHRwOi8vY3JlYXRpdmVjb21tb25zLm9yZy9saWNlbnNlcy9ieS8zLjAvZGVlZC5kZVxuICAgIGVuZHJlZ2lvblxuKi9cbi8vIHJlZ2lvbiBpbXBvcnRzXG5pbXBvcnQge1xuICAgIENoaWxkUHJvY2VzcywgZXhlYyBhcyBleGVjQ2hpbGRQcm9jZXNzLCBzcGF3biBhcyBzcGF3bkNoaWxkUHJvY2Vzc1xufSBmcm9tICdjaGlsZF9wcm9jZXNzJ1xuaW1wb3J0ICogYXMgZmlsZVN5c3RlbSBmcm9tICdmcydcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnXG5pbXBvcnQge3N5bmMgYXMgcmVtb3ZlRGlyZWN0b3J5UmVjdXJzaXZlbHlTeW5jfSBmcm9tICdyaW1yYWYnXG4vLyBOT1RFOiBPbmx5IG5lZWRlZCBmb3IgZGVidWdnaW5nIHRoaXMgZmlsZS5cbnRyeSB7XG4gICAgcmVxdWlyZSgnc291cmNlLW1hcC1zdXBwb3J0L3JlZ2lzdGVyJylcbn0gY2F0Y2ggKGVycm9yKSB7fVxuXG5pbXBvcnQgY29uZmlndXJhdGlvbiBmcm9tICcuL2NvbmZpZ3VyYXRvci5jb21waWxlZCdcbmltcG9ydCB0eXBlIHtcbiAgICBOb3JtYWxpemVkSW50ZXJuYWxJbmplY3Rpb24sIFBsYWluT2JqZWN0LCBQcm9taXNlQ2FsbGJhY2tGdW5jdGlvbixcbiAgICBSZXNvbHZlZEJ1aWxkQ29uZmlndXJhdGlvblxufSBmcm9tICcuL3R5cGUnXG5pbXBvcnQgSGVscGVyIGZyb20gJy4vaGVscGVyLmNvbXBpbGVkJ1xuLy8gZW5kcmVnaW9uXG4vLyByZWdpb24gY29udHJvbGxlclxuY29uc3QgY2hpbGRQcm9jZXNzT3B0aW9uczpPYmplY3QgPSB7XG4gICAgY3dkOiBjb25maWd1cmF0aW9uLnBhdGguY29udGV4dCxcbiAgICBlbnY6IHByb2Nlc3MuZW52LFxuICAgIHNoZWxsOiB0cnVlLFxuICAgIHN0ZGlvOiAnaW5oZXJpdCdcbn1cbmNvbnN0IGNsb3NlRXZlbnROYW1lczpBcnJheTxzdHJpbmc+ID0gW1xuICAgICdleGl0JywgJ2Nsb3NlJywgJ3VuY2F1Z2h0RXhjZXB0aW9uJywgJ1NJR0lOVCcsICdTSUdURVJNJywgJ1NJR1FVSVQnXVxuY29uc3QgY2hpbGRQcm9jZXNzZXM6QXJyYXk8Q2hpbGRQcm9jZXNzPiA9IFtdXG5jb25zdCBwcm9jZXNzUHJvbWlzZXM6QXJyYXk8UHJvbWlzZTxhbnk+PiA9IFtdXG5jb25zdCBwb3NzaWJsZUFyZ3VtZW50czpBcnJheTxzdHJpbmc+ID0gW1xuICAgICdidWlsZCcsICdidWlsZERMTCcsICdjbGVhcicsICdkb2N1bWVudCcsICdsaW50JywgJ3ByZWluc3RhbGwnLCAnc2VydmUnLFxuICAgICd0ZXN0JywgJ3Rlc3RJbkJyb3dzZXInLCAndHlwZUNoZWNrJ11cbmNvbnN0IGNsb3NlRXZlbnRIYW5kbGVyczpBcnJheTxGdW5jdGlvbj4gPSBbXVxuaWYgKGNvbmZpZ3VyYXRpb24uZ2l2ZW5Db21tYW5kTGluZUFyZ3VtZW50cy5sZW5ndGggPiAyKSB7XG4gICAgLy8gcmVnaW9uIHRlbXBvcmFyeSBzYXZlIGR5bmFtaWNhbGx5IGdpdmVuIGNvbmZpZ3VyYXRpb25zXG4gICAgLy8gTk9URTogV2UgbmVlZCBhIGNvcHkgb2YgZ2l2ZW4gYXJndW1lbnRzIGFycmF5LlxuICAgIGxldCBkeW5hbWljQ29uZmlndXJhdGlvbjpQbGFpbk9iamVjdCA9IHtnaXZlbkNvbW1hbmRMaW5lQXJndW1lbnRzOlxuICAgICAgICBjb25maWd1cmF0aW9uLmdpdmVuQ29tbWFuZExpbmVBcmd1bWVudHMuc2xpY2UoKX1cbiAgICBpZiAoXG4gICAgICAgIGNvbmZpZ3VyYXRpb24uZ2l2ZW5Db21tYW5kTGluZUFyZ3VtZW50cy5sZW5ndGggPiAzICYmXG4gICAgICAgIEhlbHBlci5wYXJzZUVuY29kZWRPYmplY3QoXG4gICAgICAgICAgICBjb25maWd1cmF0aW9uLmdpdmVuQ29tbWFuZExpbmVBcmd1bWVudHNbXG4gICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbi5naXZlbkNvbW1hbmRMaW5lQXJndW1lbnRzLmxlbmd0aCAtIDFdLFxuICAgICAgICAgICAgY29uZmlndXJhdGlvbiwgJ2NvbmZpZ3VyYXRpb24nKVxuICAgIClcbiAgICAgICAgY29uZmlndXJhdGlvbi5naXZlbkNvbW1hbmRMaW5lQXJndW1lbnRzLnBvcCgpXG4gICAgbGV0IGNvdW50Om51bWJlciA9IDBcbiAgICBsZXQgZmlsZVBhdGg6c3RyaW5nID0gYCR7Y29uZmlndXJhdGlvbi5wYXRoLmNvbnRleHR9LmAgK1xuICAgICAgICBgZHluYW1pY0NvbmZpZ3VyYXRpb24tJHtjb3VudH0uanNvbmBcbiAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgICBmaWxlUGF0aCA9IGAke2NvbmZpZ3VyYXRpb24ucGF0aC5jb250ZXh0fS5keW5hbWljQ29uZmlndXJhdGlvbi1gICtcbiAgICAgICAgICAgIGAke2NvdW50fS5qc29uYFxuICAgICAgICBpZiAoIUhlbHBlci5pc0ZpbGVTeW5jKGZpbGVQYXRoKSlcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNvdW50ICs9IDFcbiAgICB9XG4gICAgZmlsZVN5c3RlbS53cml0ZUZpbGVTeW5jKGZpbGVQYXRoLCBKU09OLnN0cmluZ2lmeShkeW5hbWljQ29uZmlndXJhdGlvbikpXG4gICAgY29uc3QgYWRkaXRpb25hbEFyZ3VtZW50czpBcnJheTxzdHJpbmc+ID0gcHJvY2Vzcy5hcmd2LnNwbGljZSgzKVxuICAgIC8vIC8gcmVnaW9uIHJlZ2lzdGVyIGV4aXQgaGFuZGxlciB0byB0aWR5IHVwXG4gICAgY2xvc2VFdmVudEhhbmRsZXJzLnB1c2goZnVuY3Rpb24oZXJyb3I6P0Vycm9yKTo/RXJyb3Ige1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgZmlsZVN5c3RlbS51bmxpbmtTeW5jKGZpbGVQYXRoKVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge31cbiAgICAgICAgaWYgKGVycm9yKVxuICAgICAgICAgICAgdGhyb3cgZXJyb3JcbiAgICAgICAgcmV0dXJuIGVycm9yXG4gICAgfSlcbiAgICAvLyAvIGVuZHJlZ2lvblxuICAgIC8vIGVuZHJlZ2lvblxuICAgIC8vIHJlZ2lvbiBoYW5kbGUgY2xlYXJcbiAgICAvKlxuICAgICAgICBOT1RFOiBBIGJ1aWxkIGNvdWxkIGRlcGVuZCBvbiBwcmV2aW91c2x5IGNyZWF0ZWQgZGxsIHBhY2thZ2VzIHNvIGFcbiAgICAgICAgY2xlYW4gc2hvdWxkIG5vdCBiZSBwZXJmb3JtZWQgaW4gdGhhdCBjYXNlLlxuICAgICovXG4gICAgaWYgKCFbJ2J1aWxkJywgJ3NlcnZlJywgJ3Rlc3RJbkJyb3dzZXInXS5pbmNsdWRlcyhcbiAgICAgICAgY29uZmlndXJhdGlvbi5naXZlbkNvbW1hbmRMaW5lQXJndW1lbnRzWzJdXG4gICAgKSAmJiBwb3NzaWJsZUFyZ3VtZW50cy5pbmNsdWRlcyhcbiAgICAgICAgY29uZmlndXJhdGlvbi5naXZlbkNvbW1hbmRMaW5lQXJndW1lbnRzWzJdXG4gICAgKSkge1xuICAgICAgICBpZiAocGF0aC5yZXNvbHZlKGNvbmZpZ3VyYXRpb24ucGF0aC50YXJnZXQpID09PSBwYXRoLnJlc29sdmUoXG4gICAgICAgICAgICBjb25maWd1cmF0aW9uLnBhdGguY29udGV4dFxuICAgICAgICApKSB7XG4gICAgICAgICAgICAvLyBSZW1vdmVzIGFsbCBjb21waWxlZCBmaWxlcy5cbiAgICAgICAgICAgIEhlbHBlci53YWxrRGlyZWN0b3J5UmVjdXJzaXZlbHlTeW5jKGNvbmZpZ3VyYXRpb24ucGF0aC50YXJnZXQsIChcbiAgICAgICAgICAgICAgICBmaWxlUGF0aDpzdHJpbmcsIHN0YXQ6T2JqZWN0XG4gICAgICAgICAgICApOj9ib29sZWFuID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoSGVscGVyLmlzRmlsZVBhdGhJbkxvY2F0aW9uKFxuICAgICAgICAgICAgICAgICAgICBmaWxlUGF0aCwgY29uZmlndXJhdGlvbi5wYXRoLmlnbm9yZVxuICAgICAgICAgICAgICAgICkpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdHlwZTpzdHJpbmcgaW4gY29uZmlndXJhdGlvbi5idWlsZClcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5ldyBSZWdFeHAoXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uLmJ1aWxkW3R5cGVdLmZpbGVOYW1lUGF0dGVyblxuICAgICAgICAgICAgICAgICAgICApLnRlc3QoZmlsZVBhdGgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoc3RhdC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlRGlyZWN0b3J5UmVjdXJzaXZlbHlTeW5jKGZpbGVQYXRoLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdsb2I6IGZhbHNlfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVTeXN0ZW0udW5saW5rU3luYyhmaWxlUGF0aClcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBmaWxlU3lzdGVtLnJlYWRkaXJTeW5jKGNvbmZpZ3VyYXRpb24ucGF0aC50YXJnZXQpLmZvckVhY2goKFxuICAgICAgICAgICAgICAgIGZpbGVOYW1lOnN0cmluZ1xuICAgICAgICAgICAgKTp2b2lkID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgIGZpbGVOYW1lLmxlbmd0aCA+ICcuZGxsLW1hbmlmZXN0Lmpzb24nLmxlbmd0aCAmJlxuICAgICAgICAgICAgICAgICAgICBmaWxlTmFtZS5lbmRzV2l0aCgnLmRsbC1tYW5pZmVzdC5qc29uJylcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgIGZpbGVTeXN0ZW0udW5saW5rU3luYyhwYXRoLnJlc29sdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uLnBhdGgudGFyZ2V0LCBmaWxlTmFtZSkpXG4gICAgICAgICAgICB9KVxuICAgICAgICB9IGVsc2VcbiAgICAgICAgICAgIHJlbW92ZURpcmVjdG9yeVJlY3Vyc2l2ZWx5U3luYyhjb25maWd1cmF0aW9uLnBhdGgudGFyZ2V0LCB7XG4gICAgICAgICAgICAgICAgZ2xvYjogZmFsc2V9KVxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmVtb3ZlRGlyZWN0b3J5UmVjdXJzaXZlbHlTeW5jKFxuICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucGF0aC5hcGlEb2N1bWVudGF0aW9uLCB7Z2xvYjogZmFsc2V9KVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge31cbiAgICB9XG4gICAgLy8gZW5kcmVnaW9uXG4gICAgLy8gcmVnaW9uIGhhbmRsZSBidWlsZFxuICAgIGNvbnN0IGJ1aWxkQ29uZmlndXJhdGlvbnM6UmVzb2x2ZWRCdWlsZENvbmZpZ3VyYXRpb24gPVxuICAgICAgICBIZWxwZXIucmVzb2x2ZUJ1aWxkQ29uZmlndXJhdGlvbkZpbGVQYXRocyhcbiAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24uYnVpbGQsIGNvbmZpZ3VyYXRpb24ucGF0aC5hc3NldC5zb3VyY2UsXG4gICAgICAgICAgICBjb25maWd1cmF0aW9uLnBhdGguY29udGV4dCwgY29uZmlndXJhdGlvbi5wYXRoLmlnbm9yZSlcbiAgICBpZiAoWydidWlsZCcsICdidWlsZERMTCcsICdkb2N1bWVudCcsICd0ZXN0J10uaW5jbHVkZXMocHJvY2Vzcy5hcmd2WzJdKSkge1xuICAgICAgICBsZXQgdGlkaWVkVXA6Ym9vbGVhbiA9IGZhbHNlXG4gICAgICAgIGNvbnN0IHRpZHlVcDpGdW5jdGlvbiA9ICgpOnZvaWQgPT4ge1xuICAgICAgICAgICAgLypcbiAgICAgICAgICAgICAgICBEZXRlcm1pbmVzIGFsbCBub25lIGphdmFTY3JpcHQgZW50aXRpZXMgd2hpY2ggaGF2ZSBiZWVuIGVtaXR0ZWRcbiAgICAgICAgICAgICAgICBhcyBzaW5nbGUgamF2YVNjcmlwdCBtb2R1bGUgdG8gcmVtb3ZlLlxuICAgICAgICAgICAgKi9cbiAgICAgICAgICAgIGlmICh0aWRpZWRVcClcbiAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIHRpZGllZFVwID0gdHJ1ZVxuICAgICAgICAgICAgY29uc3QgaW50ZXJuYWxJbmplY3Rpb246Tm9ybWFsaXplZEludGVybmFsSW5qZWN0aW9uID1cbiAgICAgICAgICAgICAgICBIZWxwZXIubm9ybWFsaXplSW50ZXJuYWxJbmplY3Rpb24oXG4gICAgICAgICAgICAgICAgICAgIEhlbHBlci5yZXNvbHZlSW5qZWN0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbi5pbmplY3Rpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICBidWlsZENvbmZpZ3VyYXRpb25zLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbi50ZXN0SW5Ccm93c2VyLmluamVjdGlvbi5pbnRlcm5hbCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ubW9kdWxlLmFsaWFzZXMsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uLmtub3duRXh0ZW5zaW9ucyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucGF0aC5jb250ZXh0LFxuICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbi5wYXRoLmlnbm9yZVxuICAgICAgICAgICAgICAgICAgICApLmludGVybmFsKVxuICAgICAgICAgICAgZm9yIChjb25zdCBjaHVua05hbWU6c3RyaW5nIGluIGludGVybmFsSW5qZWN0aW9uKVxuICAgICAgICAgICAgICAgIGlmIChpbnRlcm5hbEluamVjdGlvbi5oYXNPd25Qcm9wZXJ0eShjaHVua05hbWUpKVxuICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IG1vZHVsZUlEOnN0cmluZyBvZiBpbnRlcm5hbEluamVjdGlvbltcbiAgICAgICAgICAgICAgICAgICAgICAgIGNodW5rTmFtZVxuICAgICAgICAgICAgICAgICAgICBdKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0eXBlOj9zdHJpbmcgPSBIZWxwZXIuZGV0ZXJtaW5lQXNzZXRUeXBlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIEhlbHBlci5kZXRlcm1pbmVNb2R1bGVGaWxlUGF0aChtb2R1bGVJRCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbi5idWlsZCwgY29uZmlndXJhdGlvbi5wYXRoKVxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gVE9ETyByZXBsYWNlIGFsbCBwbGFjZWhvbGRlciBsaWtlIFtoYXNoXSBbaWRdIC4uLlxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmlsZVBhdGg6c3RyaW5nID1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uLmZpbGVzLmNvbXBvc2UuamF2YVNjcmlwdC5yZXBsYWNlKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnW25hbWVdJywgcGF0aC5qb2luKHBhdGgucmVsYXRpdmUoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXRoLmRpcm5hbWUobW9kdWxlSUQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbi5wYXRoLmNvbnRleHRcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSwgcGF0aC5iYXNlbmFtZShtb2R1bGVJRCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKS5yZXBsYWNlKC9cXD9bXj9dKyQvLCAnJylcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gJ3N0cmluZycgJiYgY29uZmlndXJhdGlvbi5idWlsZFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlXG4gICAgICAgICAgICAgICAgICAgICAgICBdKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb25maWd1cmF0aW9uLmJ1aWxkW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXS5vdXRwdXRFeHRlbnNpb24gPT09ICdqcycpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlU3lzdGVtLmNobW9kU3luYyhmaWxlUGF0aCwgJzc1NScpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7fVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBzdWZmaXg6c3RyaW5nIG9mIFsnJywgJy5tYXAnXSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZVN5c3RlbS51bmxpbmtTeW5jKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlUGF0aCArIHN1ZmZpeClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7fVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKFxuICAgICAgICAgICAgICAgIGNvbnN0IGZpbGVQYXRoOnN0cmluZyBvZiBjb25maWd1cmF0aW9uLnBhdGgudGlkeVVwXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgZmlsZVN5c3RlbS51bmxpbmtTeW5jKGZpbGVQYXRoKVxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7fVxuICAgICAgICB9XG4gICAgICAgIGNsb3NlRXZlbnRIYW5kbGVycy5wdXNoKHRpZHlVcClcbiAgICAgICAgLypcbiAgICAgICAgICAgIFRyaWdnZXJzIGNvbXBsZXRlIGFzc2V0IGNvbXBpbGluZyBhbmQgYnVuZGxlcyB0aGVtIGludG8gdGhlIGZpbmFsXG4gICAgICAgICAgICBwcm9kdWN0aXZlIG91dHB1dC5cbiAgICAgICAgKi9cbiAgICAgICAgcHJvY2Vzc1Byb21pc2VzLnB1c2gobmV3IFByb21pc2UoKFxuICAgICAgICAgICAgcmVzb2x2ZTpQcm9taXNlQ2FsbGJhY2tGdW5jdGlvbiwgcmVqZWN0OlByb21pc2VDYWxsYmFja0Z1bmN0aW9uXG4gICAgICAgICk6dm9pZCA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb21tYW5kTGluZUFyZ3VtZW50czpBcnJheTxzdHJpbmc+ID0gKFxuICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24uY29tbWFuZExpbmUuYnVpbGQuYXJndW1lbnRzIHx8IFtdXG4gICAgICAgICAgICApLmNvbmNhdChhZGRpdGlvbmFsQXJndW1lbnRzKVxuICAgICAgICAgICAgY29uc29sZS5sb2coJ1J1bm5pbmcgXCInICsgKFxuICAgICAgICAgICAgICAgIGAke2NvbmZpZ3VyYXRpb24uY29tbWFuZExpbmUuYnVpbGQuY29tbWFuZH0gYCArXG4gICAgICAgICAgICAgICAgY29tbWFuZExpbmVBcmd1bWVudHMuam9pbignICcpXG4gICAgICAgICAgICApLnRyaW0oKSArICdcIicpXG4gICAgICAgICAgICBjb25zdCBjaGlsZFByb2Nlc3M6Q2hpbGRQcm9jZXNzID0gc3Bhd25DaGlsZFByb2Nlc3MoXG4gICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbi5jb21tYW5kTGluZS5idWlsZC5jb21tYW5kLCBjb21tYW5kTGluZUFyZ3VtZW50cyxcbiAgICAgICAgICAgICAgICBjaGlsZFByb2Nlc3NPcHRpb25zKVxuICAgICAgICAgICAgY29uc3QgY29weUFkZGl0aW9uYWxGaWxlc0FuZFRpZHlVcDpGdW5jdGlvbiA9ICgpOnZvaWQgPT4ge1xuICAgICAgICAgICAgICAgIGZvciAoXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbGVQYXRoOnN0cmluZyBvZlxuICAgICAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uLmZpbGVzLmFkZGl0aW9uYWxQYXRoc1xuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzb3VyY2VQYXRoOnN0cmluZyA9IHBhdGguam9pbihcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucGF0aC5zb3VyY2UsIGZpbGVQYXRoKVxuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGVTeXN0ZW0ubHN0YXRTeW5jKHNvdXJjZVBhdGgpLmlzRGlyZWN0b3J5KCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgSGVscGVyLmNvcHlEaXJlY3RvcnlSZWN1cnNpdmVTeW5jKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VQYXRoLCBjb25maWd1cmF0aW9uLnBhdGgudGFyZ2V0KVxuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIEhlbHBlci5jb3B5RmlsZVN5bmMoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBhdGgsIGNvbmZpZ3VyYXRpb24ucGF0aC50YXJnZXQpXG4gICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRpZHlVcCgpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGNsb3NlRXZlbnROYW1lOnN0cmluZyBvZiBjbG9zZUV2ZW50TmFtZXMpXG4gICAgICAgICAgICAgICAgY2hpbGRQcm9jZXNzLm9uKGNsb3NlRXZlbnROYW1lLCBIZWxwZXIuZ2V0UHJvY2Vzc0Nsb3NlSGFuZGxlcihcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSwgcmVqZWN0LCBjbG9zZUV2ZW50TmFtZSwgKFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5hcmd2WzJdID09PSAnYnVpbGQnXG4gICAgICAgICAgICAgICAgICAgICkgPyBjb3B5QWRkaXRpb25hbEZpbGVzQW5kVGlkeVVwIDogdGlkeVVwKSlcbiAgICAgICAgICAgIGNoaWxkUHJvY2Vzc2VzLnB1c2goY2hpbGRQcm9jZXNzKVxuICAgICAgICB9KSlcbiAgICAvLyBlbmRyZWdpb25cbiAgICAvLyByZWdpb24gaGFuZGxlIHByZWluc3RhbGxcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgICBjb25maWd1cmF0aW9uLmxpYnJhcnkgJiZcbiAgICAgICAgY29uZmlndXJhdGlvbi5naXZlbkNvbW1hbmRMaW5lQXJndW1lbnRzWzJdID09PSAncHJlaW5zdGFsbCdcbiAgICApIHtcbiAgICAgICAgLy8gUGVyZm9ybSBhbGwgZmlsZSBzcGVjaWZpYyBwcmVwcm9jZXNzaW5nIHN0dWZmLlxuICAgICAgICBjb25zdCB0ZXN0TW9kdWxlRmlsZVBhdGhzOkFycmF5PHN0cmluZz4gPVxuICAgICAgICAgICAgSGVscGVyLmRldGVybWluZU1vZHVsZUxvY2F0aW9ucyhcbiAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uLnRlc3RJbkJyb3dzZXIuaW5qZWN0aW9uLmludGVybmFsLFxuICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ubW9kdWxlLmFsaWFzZXMsIGNvbmZpZ3VyYXRpb24ua25vd25FeHRlbnNpb25zLFxuICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24ucGF0aC5jb250ZXh0LCBjb25maWd1cmF0aW9uLnBhdGguaWdub3JlXG4gICAgICAgICAgICApLmZpbGVQYXRoc1xuICAgICAgICBmb3IgKGNvbnN0IGJ1aWxkQ29uZmlndXJhdGlvbiBvZiBidWlsZENvbmZpZ3VyYXRpb25zKVxuICAgICAgICAgICAgZm9yIChjb25zdCBmaWxlUGF0aDpzdHJpbmcgb2YgYnVpbGRDb25maWd1cmF0aW9uLmZpbGVQYXRocylcbiAgICAgICAgICAgICAgICBpZiAoIXRlc3RNb2R1bGVGaWxlUGF0aHMuaW5jbHVkZXMoZmlsZVBhdGgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGV2YWx1YXRpb25GdW5jdGlvbiA9IChcbiAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbDpPYmplY3QsIHNlbGY6UGxhaW5PYmplY3QsXG4gICAgICAgICAgICAgICAgICAgICAgICBidWlsZENvbmZpZ3VyYXRpb246UGxhaW5PYmplY3QsIHBhdGg6dHlwZW9mIHBhdGgsXG4gICAgICAgICAgICAgICAgICAgICAgICBhZGRpdGlvbmFsQXJndW1lbnRzOkFycmF5PHN0cmluZz4sIGZpbGVQYXRoOnN0cmluZ1xuICAgICAgICAgICAgICAgICAgICApOnN0cmluZyA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWdub3JlVHlwZUNoZWNrXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXcgRnVuY3Rpb24oXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2dsb2JhbCcsICdzZWxmJywgJ2J1aWxkQ29uZmlndXJhdGlvbicsICdwYXRoJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYWRkaXRpb25hbEFyZ3VtZW50cycsICdmaWxlUGF0aCcsICdyZXR1cm4gYCcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1aWxkQ29uZmlndXJhdGlvbltcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlndXJhdGlvbi5naXZlbkNvbW1hbmRMaW5lQXJndW1lbnRzWzJdXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXS50cmltKCkgKyAnYCdcbiAgICAgICAgICAgICAgICAgICAgICAgICkoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2xvYmFsLCBzZWxmLCBidWlsZENvbmZpZ3VyYXRpb24sIHBhdGgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkaXRpb25hbEFyZ3VtZW50cywgZmlsZVBhdGgpXG4gICAgICAgICAgICAgICAgICAgIHByb2Nlc3NQcm9taXNlcy5wdXNoKG5ldyBQcm9taXNlKChcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmU6UHJvbWlzZUNhbGxiYWNrRnVuY3Rpb24sXG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3Q6UHJvbWlzZUNhbGxiYWNrRnVuY3Rpb25cbiAgICAgICAgICAgICAgICAgICAgKTp2b2lkID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbW1hbmQ6c3RyaW5nID0gZXZhbHVhdGlvbkZ1bmN0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbCwgY29uZmlndXJhdGlvbiwgYnVpbGRDb25maWd1cmF0aW9uLCBwYXRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZGl0aW9uYWxBcmd1bWVudHMsIGZpbGVQYXRoKVxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFJ1bm5pbmcgXCIke2NvbW1hbmR9XCJgKVxuICAgICAgICAgICAgICAgICAgICAgICAgSGVscGVyLmhhbmRsZUNoaWxkUHJvY2VzcyhleGVjQ2hpbGRQcm9jZXNzKFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1hbmQsIGNoaWxkUHJvY2Vzc09wdGlvbnMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKGVycm9yOj9FcnJvcik6dm9pZCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnJvcilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgnZXhpdCcpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkpXG4gICAgICAgICAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgICAgIH1cbiAgICB9XG4gICAgLy8gZW5kcmVnaW9uXG4gICAgLy8gcmVnaW9uIGhhbmRsZSByZW1haW5pbmcgdGFza3NcbiAgICBjb25zdCBoYW5kbGVUYXNrID0gKHR5cGU6c3RyaW5nKTpudW1iZXIgPT4gcHJvY2Vzc1Byb21pc2VzLnB1c2goXG4gICAgICAgIG5ldyBQcm9taXNlKChcbiAgICAgICAgICAgIHJlc29sdmU6UHJvbWlzZUNhbGxiYWNrRnVuY3Rpb24sIHJlamVjdDpQcm9taXNlQ2FsbGJhY2tGdW5jdGlvblxuICAgICAgICApOnZvaWQgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29tbWFuZExpbmVBcmd1bWVudHM6QXJyYXk8c3RyaW5nPiA9IChcbiAgICAgICAgICAgICAgICBjb25maWd1cmF0aW9uLmNvbW1hbmRMaW5lW3R5cGVdLmFyZ3VtZW50cyB8fCBbXVxuICAgICAgICAgICAgKS5jb25jYXQoYWRkaXRpb25hbEFyZ3VtZW50cylcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdSdW5uaW5nIFwiJyArIChcbiAgICAgICAgICAgICAgICBgJHtjb25maWd1cmF0aW9uLmNvbW1hbmRMaW5lW3R5cGVdLmNvbW1hbmR9IGAgK1xuICAgICAgICAgICAgICAgIGNvbW1hbmRMaW5lQXJndW1lbnRzLmpvaW4oJyAnKVxuICAgICAgICAgICAgKS50cmltKCkgKyAnXCInKVxuICAgICAgICAgICAgY29uc3QgY2hpbGRQcm9jZXNzOkNoaWxkUHJvY2VzcyA9IHNwYXduQ2hpbGRQcm9jZXNzKFxuICAgICAgICAgICAgICAgIGNvbmZpZ3VyYXRpb24uY29tbWFuZExpbmVbdHlwZV0uY29tbWFuZCwgY29tbWFuZExpbmVBcmd1bWVudHMsXG4gICAgICAgICAgICAgICAgY2hpbGRQcm9jZXNzT3B0aW9ucylcbiAgICAgICAgICAgIGZvciAoY29uc3QgY2xvc2VFdmVudE5hbWU6c3RyaW5nIG9mIGNsb3NlRXZlbnROYW1lcylcbiAgICAgICAgICAgICAgICBjaGlsZFByb2Nlc3Mub24oY2xvc2VFdmVudE5hbWUsIEhlbHBlci5nZXRQcm9jZXNzQ2xvc2VIYW5kbGVyKFxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlLCByZWplY3QsIGNsb3NlRXZlbnROYW1lKSlcbiAgICAgICAgICAgIGNoaWxkUHJvY2Vzc2VzLnB1c2goY2hpbGRQcm9jZXNzKVxuICAgICAgICB9KSlcbiAgICAvLyAvIHJlZ2lvbiBzeW5jaHJvbm91c1xuICAgIGlmIChbJ2RvY3VtZW50JywgJ3Rlc3QnXS5pbmNsdWRlcyhcbiAgICAgICAgY29uZmlndXJhdGlvbi5naXZlbkNvbW1hbmRMaW5lQXJndW1lbnRzWzJdXG4gICAgKSlcbiAgICAgICAgUHJvbWlzZS5hbGwocHJvY2Vzc1Byb21pc2VzKS50aGVuKCgpOm51bWJlciA9PiBoYW5kbGVUYXNrKFxuICAgICAgICAgICAgY29uZmlndXJhdGlvbi5naXZlbkNvbW1hbmRMaW5lQXJndW1lbnRzWzJdKSlcbiAgICAvLyAvIGVuZHJlZ2lvblxuICAgIC8vIC8gcmVnaW9uIGFzeW5jaHJvbm91c1xuICAgIGVsc2UgaWYgKFsnbGludCcsICd0ZXN0SW5Ccm93c2VyJywgJ3R5cGVDaGVjaycsICdzZXJ2ZSddLmluY2x1ZGVzKFxuICAgICAgICBjb25maWd1cmF0aW9uLmdpdmVuQ29tbWFuZExpbmVBcmd1bWVudHNbMl1cbiAgICApKVxuICAgICAgICBoYW5kbGVUYXNrKGNvbmZpZ3VyYXRpb24uZ2l2ZW5Db21tYW5kTGluZUFyZ3VtZW50c1syXSlcbiAgICAvLyAvIGVuZHJlZ2lvblxuICAgIC8vIGVuZHJlZ2lvblxufVxubGV0IGZpbmlzaGVkOmJvb2xlYW4gPSBmYWxzZVxuY29uc3QgY2xvc2VIYW5kbGVyID0gZnVuY3Rpb24oKTp2b2lkIHtcbiAgICBpZiAoIWZpbmlzaGVkKVxuICAgICAgICBmb3IgKGNvbnN0IGNsb3NlRXZlbnRIYW5kbGVyOkZ1bmN0aW9uIG9mIGNsb3NlRXZlbnRIYW5kbGVycylcbiAgICAgICAgICAgIGNsb3NlRXZlbnRIYW5kbGVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cylcbiAgICBmaW5pc2hlZCA9IHRydWVcbn1cbmZvciAoY29uc3QgY2xvc2VFdmVudE5hbWU6c3RyaW5nIG9mIGNsb3NlRXZlbnROYW1lcylcbiAgICBwcm9jZXNzLm9uKGNsb3NlRXZlbnROYW1lLCBjbG9zZUhhbmRsZXIpXG4vLyBJZ25vcmVUeXBlQ2hlY2tcbmlmIChyZXF1aXJlLm1haW4gPT09IG1vZHVsZSAmJiAoXG4gICAgY29uZmlndXJhdGlvbi5naXZlbkNvbW1hbmRMaW5lQXJndW1lbnRzLmxlbmd0aCA8IDMgfHxcbiAgICAhcG9zc2libGVBcmd1bWVudHMuaW5jbHVkZXMoY29uZmlndXJhdGlvbi5naXZlbkNvbW1hbmRMaW5lQXJndW1lbnRzWzJdKVxuKSlcbiAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgYEdpdmUgb25lIG9mIFwiJHtwb3NzaWJsZUFyZ3VtZW50cy5qb2luKCdcIiwgXCInKX1cIiBhcyBjb21tYW5kIGxpbmUgYCArXG4gICAgICAgICdhcmd1bWVudC4gWW91IGNhbiBwcm92aWRlIGEganNvbiBzdHJpbmcgYXMgc2Vjb25kIHBhcmFtZXRlciB0byAnICtcbiAgICAgICAgJ2R5bmFtaWNhbGx5IG92ZXJ3cml0ZSBzb21lIGNvbmZpZ3VyYXRpb25zLlxcbicpXG4vLyBlbmRyZWdpb25cbi8vIHJlZ2lvbiBmb3J3YXJkIG5lc3RlZCByZXR1cm4gY29kZXNcblByb21pc2UuYWxsKHByb2Nlc3NQcm9taXNlcykuY2F0Y2goKGVycm9yOkVycm9yKTp2b2lkID0+IHByb2Nlc3MuZXhpdChcbiAgICAvLyBJZ25vcmVUeXBlQ2hlY2tcbiAgICBlcnJvci5yZXR1cm5Db2RlKSlcbi8vIGVuZHJlZ2lvblxuLy8gcmVnaW9uIHZpbSBtb2RsaW5lXG4vLyB2aW06IHNldCB0YWJzdG9wPTQgc2hpZnR3aWR0aD00IGV4cGFuZHRhYjpcbi8vIHZpbTogZm9sZG1ldGhvZD1tYXJrZXIgZm9sZG1hcmtlcj1yZWdpb24sZW5kcmVnaW9uOlxuLy8gZW5kcmVnaW9uXG4iXX0=